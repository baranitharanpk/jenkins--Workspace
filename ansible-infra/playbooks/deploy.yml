---
- name: Deploy static website to web servers
  hosts: webservers
  become: yes
  gather_facts: yes

  vars:
    # Path relative to this playbook (adjust if your repo layout differs)
    web_source_path: "{{ playbook_dir }}/../../web-app"
    web_dest_path: "/var/www/html"
    web_user: "www-data"
    web_group: "www-data"

  pre_tasks:
    - name: Ensure rsync is installed on remote (required by synchronize)
      ansible.builtin.package:
        name: rsync
        state: present

  tasks:
    - name: Ensure Apache is installed
      ansible.builtin.apt:
        name: apache2
        state: present
        update_cache: yes
      tags: ['setup']

    - name: Ensure Apache is enabled and started
      ansible.builtin.service:
        name: apache2
        enabled: yes
        state: started
      tags: ['setup']

    - name: Find existing website files (any type)
      ansible.builtin.find:
        paths: "{{ web_dest_path }}"
        file_type: any
        hidden: yes
      register: web_files
      tags: ['backup']

    - name: Create backup ONLY if files exist
      when: web_files.matched | int > 0
      ansible.builtin.archive:
        path: "{{ web_files.files | map(attribute='path') | list }}"
        dest: "/tmp/website_backup_{{ ansible_facts.date_time.epoch }}.tar.gz"
        format: gz
      tags: ['backup']

      ansible.builtin.file:
        path: "{{ web_dest_path }}"
        state: absent
      tags: ['cleanup']

    - name: Recreate website directory
      ansible.builtin.file:
        path: "{{ web_dest_path }}"
        state: directory
        owner: "{{ web_user }}"
        group: "{{ web_group }}"
        mode: '0755'
      tags: ['cleanup']
 
    - name: Copy website files from web-app repository
      become: false               
      delegate_to: localhost
      ansible.builtin.synchronize:
        src: "{{ web_source_path }}/"
        dest: "{{ web_dest_path }}/"
        delete: no
        recursive: yes
        rsync_opts:
          - "--exclude=.git"
          - "--exclude=.gitignore"
          - "--exclude=README.md"


    - name: Set proper ownership on website files
      ansible.builtin.file:
        path: "{{ web_dest_path }}"
        owner: "{{ web_user }}"
        group: "{{ web_group }}"
        recurse: yes
        mode: '0755'

    - name: Set proper permissions on files and directories
      ansible.builtin.shell: |
        find {{ web_dest_path }} -type f -exec chmod 0644 {} \;
        find {{ web_dest_path }} -type d -exec chmod 0755 {} \;
      args:
        chdir: "{{ web_dest_path }}"

    - name: Validate Apache configuration
      ansible.builtin.command: apache2ctl configtest
      register: apache_config_test
      changed_when: false
      failed_when: false

    - name: Restart Apache service
      ansible.builtin.service:
        name: apache2
        state: restarted
      when: apache_config_test.rc == 0

    - name: Wait for Apache to be ready
      ansible.builtin.wait_for:
        port: 80
        delay: 2
        timeout: 30

    - name: Display deployment information
      ansible.builtin.debug:
        msg:
          - "Deployment completed successfully!"
          - "Website URL: http://{{ ansible_host }}"
          - "Document Root: {{ web_dest_path }}"
