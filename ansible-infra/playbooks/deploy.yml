---
- name: Deploy static website to web servers
  hosts: webservers
  become: yes
  gather_facts: yes

  vars:
    # CORRECT PATH for your actual repository structure:
    # workspace/web-app/ (webapp repository: index.html, script.js, style.css)
    # workspace/repo/ansible-infra/playbooks/ (this file)
    # 
    # From playbooks/deploy.yml to web-app:
    # playbooks -> ansible-infra -> repo -> workspace -> web-app
    # That's 3 levels up (../..), then web-app
    web_source_path: "{{ playbook_dir }}/../../../web-app"
    web_dest_path: "/var/www/html"
    web_user: "www-data"
    web_group: "www-data"

  pre_tasks:
    - name: Ensure rsync is installed on remote
      ansible.builtin.package:
        name: rsync
        state: present
      tags: ['setup']

  tasks:
    - name: Ensure Apache is installed
      ansible.builtin.apt:
        name: apache2
        state: present
        update_cache: yes
      tags: ['setup']

    - name: Ensure Apache is enabled and started
      ansible.builtin.service:
        name: apache2
        enabled: yes
        state: started
      tags: ['setup']

    # ========== DEBUG & VERIFICATION ==========
    - name: Debug - Show repository and path information
      ansible.builtin.debug:
        msg:
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - "ğŸ“ PATH INFORMATION"
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - "Playbook directory: {{ playbook_dir }}"
          - "Web source path: {{ web_source_path }}"
          - "Web destination: {{ web_dest_path }}"
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      tags: ['debug', 'deploy']

    - name: Verify web-app directory exists on Jenkins controller
      delegate_to: localhost
      become: false
      ansible.builtin.stat:
        path: "{{ web_source_path }}"
      register: web_app_dir
      tags: ['deploy']

    - name: Show directory verification result
      ansible.builtin.debug:
        msg:
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - "ğŸ” DIRECTORY CHECK"
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - "Checking path: {{ web_source_path }}"
          - "Directory exists: {{ web_app_dir.stat.exists }}"
          - "Is directory: {{ web_app_dir.stat.isdir | default(false) }}"
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      tags: ['deploy']

    - name: List files in web-app directory (for verification)
      delegate_to: localhost
      become: false
      ansible.builtin.command: ls -la {{ web_source_path }}
      register: webapp_files
      when: web_app_dir.stat.exists
      changed_when: false
      tags: ['debug', 'deploy']

    - name: Show web-app repository files
      ansible.builtin.debug:
        msg: "{{ webapp_files.stdout_lines }}"
      when: web_app_dir.stat.exists
      tags: ['debug', 'deploy']

    - name: Fail if web-app directory not found
      ansible.builtin.fail:
        msg: |
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          âŒ ERROR: Web app source directory not found!
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          
          Expected location: {{ web_source_path }}
          
          Your directory structure should be:
          
          Jenkins Workspace/
          â”œâ”€â”€ web-app/              â† webapp repository (index.html, script.js, style.css)
          â”‚   â”œâ”€â”€ index.html
          â”‚   â”œâ”€â”€ script.js
          â”‚   â””â”€â”€ style.css
          â””â”€â”€ repo/                 â† jenkins--Workspace repository
              â””â”€â”€ ansible-infra/
                  â”œâ”€â”€ inventory/
                  â”‚   â””â”€â”€ hosts.ini
                  â””â”€â”€ playbooks/
                      â””â”€â”€ deploy.yml (this file)
          
          TROUBLESHOOTING:
          1. Check your Jenkinsfile has: dir('repo') { git ... }
          2. Verify both repositories were cloned successfully
          3. Check the "Verify File Structure" stage output in Jenkins
          
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      when: not web_app_dir.stat.exists or not web_app_dir.stat.isdir
      tags: ['deploy']
    # ========== /DEBUG & VERIFICATION ==========

    # ========== BACKUP ==========
    - name: Find existing website files
      ansible.builtin.find:
        paths: "{{ web_dest_path }}"
        file_type: any
        hidden: yes
      register: web_files
      ignore_errors: yes
      tags: ['backup']

    - name: Create backup if files exist
      when: web_files.matched | int > 0
      ansible.builtin.archive:
        path: "{{ web_files.files | map(attribute='path') | list }}"
        dest: "/tmp/website_backup_{{ ansible_facts.date_time.epoch }}.tar.gz"
        format: gz
      ignore_errors: yes
      tags: ['backup']

    - name: Show backup information
      when: web_files.matched | int > 0
      ansible.builtin.debug:
        msg: "âœ… Backup created at /tmp/website_backup_{{ ansible_facts.date_time.epoch }}.tar.gz"
      tags: ['backup']
    # ========== /BACKUP ==========

    # ========== CLEANUP ==========
    - name: Remove website directory completely
      ansible.builtin.file:
        path: "{{ web_dest_path }}"
        state: absent
      tags: ['cleanup']

    - name: Recreate website directory
      ansible.builtin.file:
        path: "{{ web_dest_path }}"
        state: directory
        owner: "{{ web_user }}"
        group: "{{ web_group }}"
        mode: '0755'
      tags: ['cleanup']
    # ========== /CLEANUP ==========

    # ========== CONTENT DEPLOYMENT ==========
    - name: Copy website files from webapp repository to web server
      ansible.builtin.copy:
        src: "{{ web_source_path }}/"
        dest: "{{ web_dest_path }}/"
        owner: "{{ web_user }}"
        group: "{{ web_group }}"
        mode: preserve
        remote_src: no
      tags: ['deploy']
      register: copy_result

    - name: Show deployment result
      ansible.builtin.debug:
        msg:
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - "ğŸ“¦ FILES COPIED"
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - "Source: {{ web_source_path }}"
          - "Destination: {{ web_dest_path }}"
          - "Changed: {{ copy_result.changed }}"
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      tags: ['deploy']
    # ========== /CONTENT DEPLOYMENT ==========

    # ========== PERMISSIONS ==========
    - name: Set proper ownership on website files
      ansible.builtin.file:
        path: "{{ web_dest_path }}"
        owner: "{{ web_user }}"
        group: "{{ web_group }}"
        recurse: yes
        mode: '0755'
      tags: ['permissions']

    - name: Set proper permissions on files and directories
      ansible.builtin.shell: |
        find {{ web_dest_path }} -type f -exec chmod 0644 {} \;
        find {{ web_dest_path }} -type d -exec chmod 0755 {} \;
      args:
        chdir: "{{ web_dest_path }}"
      tags: ['permissions']

    - name: Verify deployed files
      ansible.builtin.command: ls -la {{ web_dest_path }}
      register: deployed_files
      changed_when: false
      tags: ['verify']

    - name: Show deployed files
      ansible.builtin.debug:
        msg: "{{ deployed_files.stdout_lines }}"
      tags: ['verify']
    # ========== /PERMISSIONS ==========

    # ========== APACHE CONFIGURATION ==========
    - name: Validate Apache configuration
      ansible.builtin.command: apache2ctl configtest
      register: apache_config_test
      changed_when: false
      failed_when: false
      tags: ['verify']

    - name: Show Apache config test result
      ansible.builtin.debug:
        msg:
          - "Apache config test: {{ 'PASSED' if apache_config_test.rc == 0 else 'FAILED' }}"
          - "{{ apache_config_test.stderr if apache_config_test.rc != 0 else 'Configuration is valid' }}"
      tags: ['verify']

    - name: Restart Apache service
      ansible.builtin.service:
        name: apache2
        state: restarted
      when: apache_config_test.rc == 0
      tags: ['deploy']

    - name: Wait for Apache to be ready
      ansible.builtin.wait_for:
        port: 80
        delay: 2
        timeout: 30
      tags: ['verify']

    - name: Test website accessibility
      ansible.builtin.uri:
        url: "http://{{ ansible_host }}"
        method: GET
        return_content: yes
      register: website_test
      tags: ['verify']

    - name: Show website content preview
      ansible.builtin.debug:
        msg:
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - "ğŸŒ WEBSITE TEST"
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - "URL: http://{{ ansible_host }}"
          - "Status: {{ website_test.status }}"
          - "Content preview (first 500 chars):"
          - "{{ website_test.content[:500] }}"
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      tags: ['verify']
    # ========== /APACHE CONFIGURATION ==========

    # ========== DEPLOYMENT SUMMARY ==========
    - name: Display deployment summary
      ansible.builtin.debug:
        msg:
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - "âœ… DEPLOYMENT COMPLETED SUCCESSFULLY!"
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - ""
          - "ğŸŒ Website URL: http://{{ ansible_host }}"
          - "ğŸ“ Document Root: {{ web_dest_path }}"
          - "ğŸ“¦ Source Repository: webapp (index.html, script.js, style.css)"
          - "ğŸ”§ Deployed Files:"
          - "   - index.html"
          - "   - script.js"
          - "   - style.css"
          - ""
          - "ğŸ‰ Your web application is now live!"
          - ""
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      tags: ['info']
    # ========== /DEPLOYMENT SUMMARY ==========
